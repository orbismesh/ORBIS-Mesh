# /opt/orbis/orbis.conf
# ORBIS configuration (sourced by ORBIS shell scripts).
#
# LAN scheme (per-node unique /24):
#   <OCT1>.<OCT2>.<200 + NODE_ID>.<host>/24
#
# Example (NODE_ID=3, OCT1=192, OCT2=168):
#   LAN net:   192.168.203.0/24
#   Gateway:   192.168.203.1
#   UI:        192.168.203.10  (dedicated UI address)
#   SSH/eth0:  192.168.0.20   (dedicated SSH address on eth0; keep it outside DHCP range)

ORBIS_NODE_NAME="orbis-node"
# Numeric node id, typically 1..54. Leading zeros are allowed (e.g. "01").
ORBIS_NODE_ID="1"
ORBIS_COUNTRY="DE"
ORBIS_TIMEZONE="Europe/Berlin"

# Web UI binding. ORBIS will ensure ORBIS_UI_ADDR exists on br-ap.
ORBIS_UI_PORT="5000"
ORBIS_UI_ADDR_OCT4="10"
ORBIS_UI_LISTEN=""   # auto-derived below; usually leave empty

#ORBIS_UI_USER="admin"
#ORBIS_UI_PASS="orbis"

# ---- LAN addressing (br-ap) ----
# You enter OCT1, OCT2 and the gateway's host octet (OCT4). OCT3 is derived from NODE_ID.
ORBIS_LAN_OCT1="192"
ORBIS_LAN_OCT2="168"
ORBIS_LAN_GW_OCT4="1"
ORBIS_LAN_CIDR="24"

# ---- DHCP (dnsmasq on br-ap) ----
# These settings are rendered into /opt/orbis/network/generated/dnsmasq.conf.
# Keep the pool within the LAN /24 and avoid conflicts with static addresses.
ORBIS_LAN_DHCP_START=""
ORBIS_LAN_DHCP_END=""
ORBIS_LAN_DHCP_LEASE="12h"

# Optional: dedicated SSH address on eth0.
# This address is configured as a /32 on eth0 and advertised into the mesh as a host route,
# so it can be reached via Mesh even if it is outside the local LAN prefix.
# Example: "192.168.0.21"
ORBIS_SSH_ETH0_ADDR="192.168.0.20"
ORBIS_SSH_ETH0_CIDR="24"

# ---- AP ----
ORBIS_AP_IFACE="wlan0"
ORBIS_AP_BRIDGE="br-ap"
ORBIS_AP_SSID="ORBIS-AP"
ORBIS_AP_CHANNEL="6"
ORBIS_AP_HW_MODE="g"
ORBIS_AP_SEC="wpa2"
ORBIS_AP_PSK="ChangeMeApKey!"

# ---- Ethernet ----
ORBIS_ETH_IFACE="eth0"

# ---- Mesh ----
ORBIS_MESH_PHY_IFACE="wlan1"
ORBIS_MESH_IFACE="mesh0"
ORBIS_MESH_CIDR="16"
ORBIS_MESH_SSID="ORBIS-MESH"
ORBIS_MESH_FREQ_MHZ="2437"

# NOTE: 802.11s secured mesh uses SAE (wpa_supplicant requires key_mgmt=SAE or open).
# Values: open | wpa3
ORBIS_MESH_SEC="wpa3"
ORBIS_MESH_PSK="ChangeMeMeshKey!"

# Babel
ORBIS_BABELD_PORT="6696"
ORBIS_BABELD_SPLIT_HORIZON="true"

ORBIS_ROOT="/opt/orbis"
ORBIS_NETWORK_DIR="/opt/orbis/network"
ORBIS_INTERFACE_DIR="/opt/orbis/interface"

# ---- Derived values (do not edit unless you know why) ----
# Force base-10 parsing for NODE_ID (avoid octal when leading zeros are used).
# Robust numeric parse for ORBIS_NODE_ID in /bin/sh (dash): avoid 10# (bashism) and octal issues
: "${ORBIS_NODE_ID:=1}"
case "$ORBIS_NODE_ID" in
  ""|*[!0-9]*) ORBIS_NODE_ID_NUM="1" ;;
  *)
    ORBIS_NODE_ID_NUM="$(printf "%s" "$ORBIS_NODE_ID" | sed 's/^0*//; s/^$/0/')"
    ;;
esac
ORBIS_LAN_OCT3=$((200 + ORBIS_NODE_ID_NUM))
if [ "$ORBIS_LAN_OCT3" -gt 254 ]; then
  echo "WARN: ORBIS_NODE_ID=$ORBIS_NODE_ID yields LAN octet3=$ORBIS_LAN_OCT3 (>254). Clamping to 254." >&2
  ORBIS_LAN_OCT3=254
fi

ORBIS_LAN_NET="${ORBIS_LAN_OCT1}.${ORBIS_LAN_OCT2}.${ORBIS_LAN_OCT3}.0"
ORBIS_LAN_ADDR="${ORBIS_LAN_OCT1}.${ORBIS_LAN_OCT2}.${ORBIS_LAN_OCT3}.${ORBIS_LAN_GW_OCT4}"

# DHCP pool defaults (can be overridden above).
[ -n "${ORBIS_LAN_DHCP_START}" ] || ORBIS_LAN_DHCP_START="${ORBIS_LAN_OCT1}.${ORBIS_LAN_OCT2}.${ORBIS_LAN_OCT3}.50"
[ -n "${ORBIS_LAN_DHCP_END}" ] || ORBIS_LAN_DHCP_END="${ORBIS_LAN_OCT1}.${ORBIS_LAN_OCT2}.${ORBIS_LAN_OCT3}.199"

ORBIS_UI_ADDR="${ORBIS_LAN_OCT1}.${ORBIS_LAN_OCT2}.${ORBIS_LAN_OCT3}.${ORBIS_UI_ADDR_OCT4}"
[ -n "${ORBIS_UI_LISTEN}" ] || ORBIS_UI_LISTEN="${ORBIS_UI_ADDR}"

# SSH mgmt address (optional). If unset, default to <LAN>.2 (outside default DHCP pool).
[ -n "${ORBIS_SSH_ETH0_ADDR}" ] || ORBIS_SSH_ETH0_ADDR="${ORBIS_LAN_OCT1}.${ORBIS_LAN_OCT2}.${ORBIS_LAN_OCT3}.2"

# Mesh address remains per-node unique in a shared /16
ORBIS_MESH_ADDR="10.10.${ORBIS_NODE_ID_NUM}.1"
