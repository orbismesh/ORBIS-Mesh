{% extends "base.html" %}

{% block content %}
<section class="card-grid">
    <h2 class="card-grid-title">ㅤ</h2>

    <article class="card">
        <h2 class="card-title">Identity</h2>
            <form class="form" method="post" action="{{ url_for('network_config') }}">
            <input type="hidden" name="action" value="save_identity">

            <div class="form-grid-2">
                <div class="form-group">
                    <label for="new_node_name">Node Name</label>
                    <input id="new_node_name" name="new_node_name" type="text" placeholder="e.g. Node 1" value="{{ current_node_name or '' }}" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="new_node_id">Node ID</label>
                    <input id="new_node_id" name="new_node_id" type="number" min="1" step="1" placeholder="e.g. 1" value="{{ current_node_id or '' }}">
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">Save</button>
            </div>
        </form>
    </article>

    <article class="card">
        <h2 class="card-title">Mesh Adapter</h2>

        <form class="form" method="post" action="{{ url_for('network_config') }}" onsubmit="return window.confirm('This triggers a network services reboot. Continue?');">
            <input type="hidden" name="action" value="save_mesh_adapter">
            <input type="hidden" id="mesh_country_code_live" name="mesh_country_code_live" value="{{ current_country_code }}">

            <div class="form-grid-2">
                <div class="form-group">
                    <label for="mesh_adapter_1">Adapter 1</label>
                    <select id="mesh_adapter_1" name="mesh_adapter_1" required>
                        <option value="" disabled selected>Loading…</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mesh_channel_1">Channel</label>
                    <select id="mesh_channel_1" name="mesh_channel_1" required>
                        <option value="" disabled selected>Select adapter first…</option>
                    </select>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">Save</button>
            </div>
        </form>

        <script>
            window.addEventListener('DOMContentLoaded', function () {
                const adapterSel = document.getElementById('mesh_adapter_1');
                const channelSel = document.getElementById('mesh_channel_1');
                const countryLive = document.getElementById('mesh_country_code_live');
                const hint = document.getElementById('mesh_channel_hint');

                function countrySel() {
                    // The Country Code select is rendered later in the page, so we look it up dynamically.
                    return document.getElementById('mesh_country_code');
                }

                function getCountry() {
                    const cs = countrySel();
                    const v = (cs && cs.value) ? cs.value : (countryLive ? (countryLive.value || '') : '');
                    return (v || '').toUpperCase();
                }

                function setHint(text) {
                    if (!hint) return;
                    hint.textContent = text || '';
                }

                function resetChannels(placeholder) {
                    if (!channelSel) return;
                    channelSel.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.disabled = true;
                    opt.selected = true;
                    opt.textContent = placeholder || 'Select adapter first…';
                    channelSel.appendChild(opt);
                }

                async function loadAdapters() {
                    try {
                        const r = await fetch('/api/mesh-adapters', { credentials: 'same-origin' });
                        const data = await r.json();
                        adapterSel.innerHTML = '';

                        const ph = document.createElement('option');
                        ph.value = '';
                        ph.disabled = true;
                        ph.selected = true;
                        ph.textContent = 'Select adapter…';
                        adapterSel.appendChild(ph);

                        const adapters = (data && data.adapters) ? data.adapters : [];
                        const current = (data && data.current_if) ? data.current_if : ("{{ current_mesh_if or '' }}");

                        for (const a of adapters) {
                            const opt = document.createElement('option');
                            opt.value = a.ifname;
                            const bands = (a.bands && a.bands.length) ? ` [${a.bands.join('/')}]` : '';
                            let label = `${a.ifname} (${a.description || 'Wi-Fi adapter'})${bands}`;
                            if (!a.mesh_supported) {
                                label += ' — Does not support mesh';
                                opt.disabled = true;
                            }
                            opt.textContent = label;
                            adapterSel.appendChild(opt);
                        }

                        // Preselect current config if present
                        if (current) {
                            for (const o of adapterSel.options) {
                                if (o.value === current) {
                                    o.selected = true;
                                    break;
                                }
                            }
                        }

                        resetChannels('Loading channels…');
                        await loadChannels();
                    } catch (e) {
                        adapterSel.innerHTML = '<option value="" disabled selected>Failed to load adapters</option>';
                        resetChannels('No channels');
                        setHint('Failed to load adapter list.');
                    }
                }

                async function loadChannels() {
                    const ifname = adapterSel.value;
                    if (!ifname) {
                        resetChannels('Select adapter first…');
                        setHint('');
                        return;
                    }

                    // Persist the currently selected Country Code into the mesh-adapter form (live behavior).
                    const country = getCountry();
                    if (countryLive) countryLive.value = country;

                    try {
                        resetChannels('Loading channels…');
                        setHint('');
                        const url = `/api/mesh-channels?ifname=${encodeURIComponent(ifname)}&country=${encodeURIComponent(country)}`;
                        const r = await fetch(url, { credentials: 'same-origin' });
                        const data = await r.json();

                        const channels = (data && data.channels) ? data.channels : [];
                        channelSel.innerHTML = '';

                        if (!channels.length) {
                            resetChannels('No channels available');
                            const used = (data && data.country) ? data.country : country;
                            setHint(`No channels are available for ${ifname} with Country Code ${used}. Verify adapter capabilities and regulatory settings.`);
                            return;
                        }

                        const ph = document.createElement('option');
                        ph.value = '';
                        ph.disabled = true;
                        ph.selected = true;
                        ph.textContent = 'Select channel…';
                        channelSel.appendChild(ph);

                        // Grouping by band is done via optgroups.
                        const groups = {};
                        for (const ch of channels) {
                            const band = ch.band || 'Wi-Fi';
                            if (!groups[band]) {
                                const og = document.createElement('optgroup');
                                og.label = band;
                                groups[band] = og;
                                channelSel.appendChild(og);
                            }
                            const opt = document.createElement('option');
                            opt.value = String(ch.freq_mhz);
                            opt.textContent = `ch ${ch.channel} (${ch.freq_mhz} MHz)`;
                            groups[band].appendChild(opt);
                        }

                        // Preselect current frequency if available
                        const currentFreq = (data && data.current_frequency1) ? String(data.current_frequency1) : ("{{ current_mesh_frequency1 or '' }}");
                        if (currentFreq) {
                            for (const o of channelSel.options) {
                                if (o.value === currentFreq) {
                                    o.selected = true;
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        resetChannels('No channels available');
                        setHint('No channels are available. Verify Country Code selection and adapter capabilities.');
                    }
                }

                // Reload channels if adapter changes (live behavior).
                adapterSel.addEventListener('change', loadChannels);

                // Reload channels if Country Code changes (live behavior).
                const cs = countrySel();
                if (cs) cs.addEventListener('change', loadChannels);

                // Ensure form submits the live country selection.
                const form = adapterSel.closest('form');
                if (form) {
                    form.addEventListener('submit', function () {
                        if (countryLive) countryLive.value = getCountry();
                    });
                }

                loadAdapters();
            });
        </script>
    </article>

    <article class="card">
        <h2 class="card-title">Mesh Parameters</h2>
        <form class="form" method="post" action="{{ url_for('network_config') }}" onsubmit="return window.confirm('This triggers a network services reboot. Continue?');">
            <input type="hidden" name="action" value="save_mesh_params">

            <div class="form-grid-2">
                <div class="form-group">
                    
                    <label for="new_mesh_ssid">Mesh SSID</label>
                    <input id="new_mesh_ssid" name="new_mesh_ssid" type="text" placeholder="e.g. orbis_mesh" value="{{ current_mesh_ssid or '' }}" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="new_mesh_password">Password</label>
                    <input id="new_mesh_password" name="new_mesh_password" type="password" placeholder="•••••••••" value="{{ current_mesh_password or '' }}" autocomplete="new-password">
                </div>               
            </div>

            <div class="form-grid-2">
                <div class="form-group">
                    <label for="mesh_hop_limit">Hop Limit</label>
                    <input id="mesh_hop_limit" name="mesh_hop_limit" type="number" min="1" max="255" placeholder="e.g. 31" value="{{ current_mesh_hop_limit or '' }}">
                </div>
            </div>

            <div class="form-grid-2">
                <div class="form-group">
                    <label for="mesh_country_code">Country Code</label>
                    <select id="mesh_country_code" name="mesh_country_code" required>
                        {% for c in countries %}
                            <option value="{{ c.code }}" {% if c.code == current_country_code %}selected{% endif %}>{{ c.name }} ({{ c.code }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="mesh_encryption">Encryption</label>
                    <select id="mesh_encryption" name="mesh_encryption" required>
                        {% for opt in mesh_encryption_options %}
                            <option value="{{ opt.value }}"
                                    {% if opt.value == current_mesh_encryption %}selected{% endif %}
                                    {% if not opt.enabled %}disabled{% endif %}
                                    {% if opt.reason %}title="{{ opt.reason }}"{% endif %}>
                                {{ opt.label }}{% if not opt.enabled %} ({{ opt.reason or 'Not supported' }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">Save</button>
            </div>
        </form>
    </article>

    <article class="card">
        <h2 class="card-title">Node IP</h2>
            <form class="form form-inline" method="post" action="{{ url_for('network_config') }}"
              onsubmit="return confirm('Saving these settings will reboot the system. Continue?');">
            <input type="hidden" name="action" value="save_identity">

            <div class="form-grid-2">
                <div class="form-group">
                    <label for="new_node_name">Mesh / AP IP</label>
                    <input type="text" id="ip_address" name="ip_address" placeholder="e.g. 192.168.200.10" value="{{ current_node_ip or '' }}" required>
                </div>

                <div class="form-group">
                    <label for="new_node_id">Suffix (CIDR)</label>
                    <input type="number" id="ip_suffix" name="ip_suffix" min="0" max="32" placeholder="e.g. 24" value="{{ current_node_cidr or '' }}" required>
                </div>
            </div>

            <div class="form-grid-2">
                <div class="form-group">
                    <label for="dns_address">DNS (Must match Mesh IP)</label>
                    <input type="text" id="dns_address" name="dns_address" placeholder="e.g. 192.168.200.10" value="{{ current_dns or '' }}">
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">Save</button>
            </div>
        </form>
    </article>

    <article class="card">
        <h2 class="card-title">Mesh Band Scan</h2>
        <div class="form-actions">
            <button type="button" id="scanNowBtn" class="btn-primary">Scan Now</button>
        </div>
        
        <div id="scanStatus" style="margin-top: 1rem; display: none;">
            <p style="color: var(--text-muted);">Scanning... This may take up to 30 seconds.</p>
        </div>
        
        <div id="scanResults" style="margin-top: 1rem; display: none;">
            <h3 style="margin-bottom: 0.5rem;">Scan Results</h3>
            <p id="scanTime" style="color: var(--text-muted); font-size: 0.9rem;"></p>
            <p id="scanSummary" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;"></p>
            
            <details style="margin-bottom: 1rem; padding: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px;">
                <summary style="cursor: pointer; font-weight: bold; padding: 0.25rem;">Debug: Detected Networks</summary>
                <div id="debugInfo" style="margin-top: 0.5rem; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto;"></div>
            </details>
            
            <details style="margin-bottom: 1rem; padding: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px;">
                <summary style="cursor: pointer; font-weight: bold; padding: 0.25rem;">Debug: Raw Scan Output</summary>
                <div id="rawScanOutput" style="margin-top: 0.5rem; font-family: monospace; font-size: 0.75rem; max-height: 300px; overflow-y: auto; white-space: pre-wrap; background: #1e1e1e; color: #d4d4d4; padding: 0.5rem; border-radius: 4px;"></div>
            </details>
            
            <div id="band24ghz" style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.5rem;">2.4 GHz Band</h4>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Note: 2.4 GHz channels overlap. Channels 1, 6, and 11 are non-overlapping.</p>
                <div id="channels24ghz" style="font-family: monospace; font-size: 0.9rem;"></div>
            </div>
            
            <div id="band5ghz" style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.5rem;">5 GHz Band</h4>
                <div id="channels5ghz" style="font-family: monospace; font-size: 0.9rem;"></div>
            </div>
            
            <div id="band6ghz" style="margin-bottom: 1.5rem; display: none;">
                <h4 style="margin-bottom: 0.5rem;">6 GHz Band</h4>
                <div id="channels6ghz" style="font-family: monospace; font-size: 0.9rem;"></div>
            </div>
        </div>
        
        <div id="scanError" style="margin-top: 1rem; display: none; color: var(--error-color);">
            <p id="errorMessage"></p>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const scanBtn = document.getElementById('scanNowBtn');
                const scanStatus = document.getElementById('scanStatus');
                const scanResults = document.getElementById('scanResults');
                const scanError = document.getElementById('scanError');
                const scanTime = document.getElementById('scanTime');
                const scanSummary = document.getElementById('scanSummary');
                const debugInfo = document.getElementById('debugInfo');
                const rawScanOutput = document.getElementById('rawScanOutput');
                const channels24ghz = document.getElementById('channels24ghz');
                const channels5ghz = document.getElementById('channels5ghz');
                const channels6ghz = document.getElementById('channels6ghz');
                const band6ghz = document.getElementById('band6ghz');
                const errorMessage = document.getElementById('errorMessage');

                function getQualityColor(score) {
                    if (score === 0) return '#28a745'; // Green - excellent
                    if (score < 30) return '#90EE90'; // Light green - very good
                    if (score < 60) return '#ffc107'; // Yellow - good
                    if (score < 100) return '#fd7e14'; // Orange - fair
                    return '#dc3545'; // Red - poor
                }

                function getQualityLabel(score) {
                    if (score === 0) return 'Excellent';
                    if (score < 30) return 'Very Good';
                    if (score < 60) return 'Good';
                    if (score < 100) return 'Fair';
                    return 'Poor';
                }

                function formatChannelList(channels) {
                    if (!channels || channels.length === 0) {
                        return '<p style="color: var(--text-muted);">No channels available</p>';
                    }

                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead><tr style="border-bottom: 1px solid var(--border-color);">';
                    html += '<th style="text-align: left; padding: 0.5rem;">CH</th>';
                    html += '<th style="text-align: left; padding: 0.5rem;">FRQ</th>';
                    html += '<th style="text-align: left; padding: 0.5rem;">Quality</th>';
                    html += '<th style="text-align: left; padding: 0.5rem;">Networks</th>';
                    html += '<th style="text-align: left; padding: 0.5rem;">Avg Signal</th>';
                    html += '</tr></thead><tbody>';

                    channels.forEach(function(ch) {
                        const color = getQualityColor(ch.quality_score);
                        const label = getQualityLabel(ch.quality_score);
                        const signal = ch.avg_signal !== null ? ch.avg_signal + ' dBm' : 'N/A';
                        
                        html += '<tr style="border-bottom: 1px solid var(--border-color);">';
                        html += '<td style="padding: 0.5rem; font-weight: bold;">' + ch.channel + '</td>';
                        html += '<td style="padding: 0.5rem;">' + ch.frequency + ' MHz</td>';
                        html += '<td style="padding: 0.5rem;"><span style="color: ' + color + '; font-weight: bold;">● </span>' + label + '</td>';
                        html += '<td style="padding: 0.5rem;">' + ch.networks + '</td>';
                        html += '<td style="padding: 0.5rem;">' + signal + '</td>';
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                    return html;
                }

                scanBtn.addEventListener('click', async function() {
                    // Hide previous results and errors
                    scanResults.style.display = 'none';
                    scanError.style.display = 'none';
                    
                    // Show scanning status
                    scanStatus.style.display = 'block';
                    scanBtn.disabled = true;
                    scanBtn.textContent = 'Scanning...';

                    try {
                        const response = await fetch('/api/band-scan', {
                            credentials: 'same-origin'
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Scan failed');
                        }

                        // Hide scanning status
                        scanStatus.style.display = 'none';

                        // Format scan time
                        const scanDate = new Date(data.scan_time);
                        scanTime.textContent = 'Scanned at: ' + scanDate.toLocaleString();
                        
                        // Show summary
                        scanSummary.textContent = 'Found ' + data.total_networks_found + ' networks in total';
                        if (data.interface_mode) {
                            scanSummary.textContent += ' | Interface mode: ' + data.interface_mode;
                        }
                        
                        // Show raw scan output
                        if (data.raw_scan_output) {
                            rawScanOutput.textContent = data.raw_scan_output;
                        } else {
                            rawScanOutput.textContent = 'No raw output available';
                        }
                        
                        // Show debug info
                        if (data.detected_networks && data.detected_networks.length > 0) {
                            let debugHtml = '<table style="width: 100%; font-size: 0.85rem;"><thead><tr>';
                            debugHtml += '<th style="text-align: left; padding: 0.25rem;">Band</th>';
                            debugHtml += '<th style="text-align: left; padding: 0.25rem;">CH</th>';
                            debugHtml += '<th style="text-align: left; padding: 0.25rem;">Freq</th>';
                            debugHtml += '<th style="text-align: left; padding: 0.25rem;">Count</th>';
                            debugHtml += '<th style="text-align: left; padding: 0.25rem;">Signals (dBm)</th>';
                            debugHtml += '</tr></thead><tbody>';
                            
                            data.detected_networks.forEach(function(net) {
                                debugHtml += '<tr>';
                                debugHtml += '<td style="padding: 0.25rem;">' + net.band + '</td>';
                                debugHtml += '<td style="padding: 0.25rem;">' + net.channel + '</td>';
                                debugHtml += '<td style="padding: 0.25rem;">' + net.frequency + '</td>';
                                debugHtml += '<td style="padding: 0.25rem;">' + net.count + '</td>';
                                debugHtml += '<td style="padding: 0.25rem;">' + net.signals.join(', ') + '</td>';
                                debugHtml += '</tr>';
                            });
                            
                            debugHtml += '</tbody></table>';
                            debugInfo.innerHTML = debugHtml;
                        } else {
                            debugInfo.innerHTML = '<p>No networks detected</p>';
                        }

                        // Display results for each band
                        channels24ghz.innerHTML = formatChannelList(data.bands['2.4GHz']);
                        channels5ghz.innerHTML = formatChannelList(data.bands['5GHz']);
                        
                        // Show 6GHz band only if channels are available
                        if (data.bands['6GHz'] && data.bands['6GHz'].length > 0) {
                            channels6ghz.innerHTML = formatChannelList(data.bands['6GHz']);
                            band6ghz.style.display = 'block';
                        } else {
                            band6ghz.style.display = 'none';
                        }

                        // Show results
                        scanResults.style.display = 'block';

                    } catch (error) {
                        // Hide scanning status
                        scanStatus.style.display = 'none';
                        
                        // Show error
                        errorMessage.textContent = 'Error: ' + error.message;
                        scanError.style.display = 'block';
                    } finally {
                        scanBtn.disabled = false;
                        scanBtn.textContent = 'Scan Now';
                    }
                });
            });
        </script>
    </article>

</section>

{% endblock %}

